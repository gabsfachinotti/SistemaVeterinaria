@model IEnumerable<SistemaVeterinaria.Models.Vaccine>
@{
    ViewBag.Title = "DailyNotification";
}

<h2 class="text-center">Vacunas programadas para Hoy</h2>
<hr style="color: grey; border-color: grey; margin-top: 0" />
<table id="table" class="table table-bordered">
    <thead>
        <tr style="background: lightsteelblue">
            <th>
                Nro
            </th>
            <th>
                Paciente
            </th>
            <th class="text-center">
                Especie
            </th>            
            <th class="text-center">
                Ordinal
            </th>
            <th class="text-center">
                Fecha
            </th>
            <th class="text-center">
                Dueño
            </th>
            <th class="text-center">
                Teléfono
            </th>
            <th class="text-center">
                Opciones
            </th>
        </tr>
    </thead>
    <tbody id="Vaccines">
        @foreach (var item in Model)
        {
            <tr id="@("Vaccine" + item.VaccineId)">
                <td id="@("VaccineId" + item.VaccineId)">
                    @item.VaccineId
                </td>
                <td id="@("PetName" + item.VaccineId)">
                    @Html.DisplayFor(modelItem => item.Pet.PetName)
                </td>
                <td id="@("PetSpecie" + item.VaccineId)" class="text-center">
                    @Html.DisplayFor(modelItem => item.Pet.PetSpecie)
                </td>                
                <td id="@("VaccineNumber" + item.VaccineId)" class="text-center">
                    @item.VaccineNumber° Vacuna
                </td>
                <td id="@("VaccineDate" + item.VaccineId)" class="text-center">
                    @item.VaccineDate.ToShortDateString()
                </td>
                <td id="@("Owner" + item.VaccineId)" class="text-center">
                    @item.Pet.Owner.OwnerLastName, @item.Pet.Owner.OwnerName
                </td>
                <td class="text-center">
                    @item.Pet.Owner.OwnerPhone
                </td>
                <td id="@("Options" + item.VaccineId)" class="text-center">
                    <button class="btn btn-success btn-sm" title="Aplazar" onclick="postpone(@item.VaccineId,@item.PetId)"><span class="glyphicon glyphicon-share-alt" aria-hidden="true"></span></button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div id="modalPostpone" class="modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width:110%;margin-left:-10%">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closePostpone">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h5 class="modal-title">Aplazar Notificación</h5>
            </div>
            <div class="modal-body">                
                @*<p id="message">¿Está seguro de posponer la notificación Nro # para el día @DateTime.Today.AddDays(1).ToString("D")?</p>*@                
                <div class="modalinput">
                    <label class="modallabel">Nro Vacuna:</label>
                    <p id="EditVaccineId"></p>
                </div>
                <div class="modalinput">
                    <label class="modallabel">Ordinal:</label>
                    <p id="EditVaccineNumber"></p>
                </div>
                <div class="modalinput">
                    <label class="modallabel">Fecha:</label>
                    <input id="EditVaccineDate"  style="width:30%" type="date" />
                </div>
                <span id="EditVaccineDateSpan" style="color:red;display:none;margin-left:30%"></span>
                <div class="modalinput" style="margin-top:1%">
                    <label class="modallabel">Paciente:</label>
                    <p id="EditPetId" style="display:none"></p>
                    <p id="EditVaccinePet"></p>
                </div>
                <div style="margin-left:10%;margin-top:7%">
                    <text style="color:red;font-weight:bold">IMPORTANTE:</text>
                    <span>Si modifica la fecha de la notificación, se modificarán las fechas de las notificaciones posteriores.</span>
                </div>
            </div>
            <div class="modal-footer">
                <button id="Postpone" type="button" class="btn btn-primary">Aplazar</button>
                <button id="Cancel" type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
        function postpone(vaccineId,petId) {
            $('#EditVaccineId').text($('#VaccineId' + vaccineId).html().trim());
            $('#EditVaccineNumber').text($('#VaccineNumber' + vaccineId).html().trim());
            var date = $('#VaccineDate' + vaccineId).html().trim();
            var day = date.split('/')[0];
            var month = date.split('/')[1];
            var year = date.split('/')[2]

            if (day < 10) {
                day = '0' + day;
            }

            if (month < 10) {
                month = '0' + month;
            }

            $('#EditVaccineDate').val(year + '-' + month + '-' + day);
            $('#EditVaccineDateSpan').hide();
            $('#EditPetId').text(petId);
            var pet = $('#PetName' + vaccineId).html().trim() + ' (' + $('#PetSpecie' + vaccineId).html().trim() + ')' + ' - ' + $('#Owner' + vaccineId).html().trim();
            $('#EditVaccinePet').text(pet);

            $('#modalPostpone').show('slow');
        }

        $('#Postpone').click(function () {
            var date = String($('#EditVaccineDate').val());
            var currentdate = $('#VaccineDate' + $('#EditVaccineId').text()).html().trim();

            date = date.split('-')[0] + date.split('-')[1] + date.split('-')[2];

            var day = currentdate.split('/')[0];
            var month = currentdate.split('/')[1];
            var year = currentdate.split('/')[2]

            if (day < 10) {
                day = '0' + day;
            }

            if (month < 10) {
                month = '0' + month;
            }

            currentdate = year + month + day;

            if (date < currentdate) {
                $('#EditVaccineDateSpan').text('La nueva fecha no puede ser menor a la actual.').show();
            } else {
                $('#modalPostpone').hide('slow');
                if (date > currentdate) {
                    var vaccine = {
                        VaccineId: parseInt($('#EditVaccineId').text()),
                        VaccineNumber: parseInt($('#EditVaccineNumber').text()),
                        VaccineDate: $('#EditVaccineDate').val(),
                        PetId: parseInt($('#EditPetId').text()),
                        Pet: null
                    }

                    $.ajax({
                        url: '@Url.Action("EditVaccine","Vaccines")',
                        type: "POST",
                        data: JSON.stringify(vaccine),
                        dataType: "JSON",
                        contentType: "application/json",
                        success: function (d) {
                            toastr.success('Se han modificado ' + String(d.vaccineDates.length) + ' notificaciones de Vacunas.');

                            //$('#VaccineDate' + d.vaccineId).html(d.vaccineDates[0]);

                            $('#Options' + d.vaccineId).html('Aplazado al ' + d.vaccineDates[0]).css('color', 'red');
                            $('#Vaccine' + d.vaccineId).css("background-color", "#5cb85c26");
                            toastr.info('AL actualizar la página no se visualizarán la notificaciones aplazadas.');
                        }
                    })
                }
            }
        });

        $('#Cancel').click(function () {
            $('#modalPostpone').hide('slow');
        });

        $('#closePostpone').click(function () {
            $('#modalPostpone').hide('slow');
        });
    </script>
}
